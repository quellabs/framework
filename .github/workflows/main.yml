name: Sync to Public Repos

on:
  push:
    branches: [main]
    tags: ['*.*.*']
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual changes)'
        required: false
        default: false
        type: boolean

jobs:
  sync-and-release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package:
          - contracts
          - support
          - discover
          - dependency-injection
          - sculpt
          - cache
          - objectquel
          - signal-hub
          - annotation-reader
          - canvas
          - canvas-objectquel
          - canvas-smarty
          - canvas-twig
          - canvas-skeleton
          - canvas-database
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_TOKEN }}

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Sync package to public repo
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run || false }}
        run: |
          set -e
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "üîç DRY RUN MODE - No actual changes"
            echo "Would sync ${{ matrix.package }} to public repo"
            exit 0
          fi
          
          echo "üì¶ Syncing ${{ matrix.package }}..."
          
          if ! git subtree push --prefix=packages/${{ matrix.package }} \
            https://${{ secrets.SYNC_TOKEN }}@github.com/quellabs/${{ matrix.package }}.git main; then
            echo "‚ùå Sync failed"
            exit 1
          fi
          
          echo "‚úÖ Sync complete"

      - name: Check for release requirement
        id: check_release
        run: |
          echo "üè∑Ô∏è  Checking release for ${{ matrix.package }}..."
          
          if [ ! -f "versioning/versions.json" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=versions.json not found" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          target_version=$(jq -r --arg pkg "${{ matrix.package }}" '.[$pkg] // empty' versioning/versions.json)
          
          if [ -z "$target_version" ] || [ "$target_version" = "null" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "reason=no version specified" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if ! [[ "$target_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+.*$ ]]; then
            echo "‚ùå Invalid version format: $target_version (expected semver without v prefix)"
            exit 1
          fi
          
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "target_version=$target_version" >> $GITHUB_OUTPUT

      - name: Report skip reason
        if: steps.check_release.outputs.skip == 'true'
        run: |
          case "${{ steps.check_release.outputs.reason }}" in
            "versions.json not found")
              echo "üìù versioning/versions.json not found - skipping release"
              ;;
            "no version specified")
              echo "üìù No version specified for ${{ matrix.package }} - skipping release"
              ;;
          esac

      - name: Get current version from public repo
        id: get_version
        if: steps.check_release.outputs.skip == 'false'
        run: |
          if ! tags_response=$(curl -sf -H "Authorization: token ${{ secrets.SYNC_TOKEN }}" \
            "https://api.github.com/repos/quellabs/${{ matrix.package }}/tags" 2>/dev/null); then
            echo "current_version=0.0.0" >> $GITHUB_OUTPUT
            echo "  Current: 0.0.0 (repo not found or no tags)"
            exit 0
          fi
          
          current_version=$(echo "$tags_response" \
            | jq -r '.[].name' \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -V \
            | tail -n 1)
          
          if [ -z "$current_version" ]; then
            current_version="0.0.0"
          fi
          
          echo "current_version=$current_version" >> $GITHUB_OUTPUT
          echo "  Current: $current_version"
          echo "  Target:  ${{ steps.check_release.outputs.target_version }}"

      - name: Determine if release needed
        id: version_compare
        if: steps.check_release.outputs.skip == 'false'
        run: |
          version_gt() {
            test "$(printf '%s\n' "$@" | sort -V | head -n 1)" != "$1"
          }
          
          current="${{ steps.get_version.outputs.current_version }}"
          target="${{ steps.check_release.outputs.target_version }}"
          
          if version_gt "$target" "$current"; then
            echo "create=true" >> $GITHUB_OUTPUT
            echo "  ‚Üí New version detected! Releasing $target"
          elif [ "$current" = "$target" ]; then
            echo "create=false" >> $GITHUB_OUTPUT
            echo "  ‚úÖ Already up to date"
          else
            echo "create=false" >> $GITHUB_OUTPUT
            echo "  ‚ö†Ô∏è  Target ($target) older than current ($current)"
          fi

      - name: Create and push release tag
        if: steps.version_compare.outputs.create == 'true'
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run == 'true' && 'true' || 'false' }}
          TARGET_VERSION: ${{ steps.check_release.outputs.target_version }}
        run: |
          set -e
          
          if [ "$DRY_RUN" = "true" ]; then
            echo "üîç DRY RUN: Would tag ${{ matrix.package }} with $TARGET_VERSION"
            exit 0
          fi
          
          rm -rf "temp-${{ matrix.package }}"
          
          if ! git clone "https://${{ secrets.SYNC_TOKEN }}@github.com/quellabs/${{ matrix.package }}.git" "temp-${{ matrix.package }}" 2>/dev/null; then
            echo "‚ùå Failed to clone repository"
            exit 1
          fi
          
          cd "temp-${{ matrix.package }}"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if git tag -l | grep -q "^$TARGET_VERSION$"; then
            echo "‚ùå Tag $TARGET_VERSION already exists"
            cd ..
            rm -rf "temp-${{ matrix.package }}"
            exit 1
          fi
          
          if ! git tag -a "$TARGET_VERSION" -m "Release $TARGET_VERSION"; then
            echo "‚ùå Failed to create tag"
            exit 1
          fi
          
          if ! git push origin "$TARGET_VERSION"; then
            echo "‚ùå Failed to push tag. Diagnostics:"
            echo "‚Üí Recent commits:"
            git log -3 --oneline || true
            echo "‚Üí Git status:"
            git status || true
            echo "‚Üí Existing tags:"
            git tag --sort=-creatordate | head -5 || true
            cd ..
            rm -rf "temp-${{ matrix.package }}"
            exit 1
          fi
          
          echo "‚úÖ Tagged ${{ matrix.package }} with $TARGET_VERSION"
          
          cd ..
          rm -rf "temp-${{ matrix.package }}"

      - name: Summary
        if: always()
        run: echo "üéâ Completed ${{ matrix.package }}"